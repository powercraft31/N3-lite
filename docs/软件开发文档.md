# N3Lite-1.0 软件开发文档

## 一、项目概述

**项目名称**: N3Lite-1.0
**项目类型**: 充电桩管理控制系统（基于ESP32）
**开发框架**: ESP-IDF v5.5.1
**操作系统**: FreeRTOS
**编程语言**: C语言

---

## 二、硬件资源使用

### 2.1 GPIO引脚分配

#### LED指示灯（9个）

| GPIO | 功能 | 说明 |
|------|------|------|
| GPIO13 | LED_MONO_1 | 电流档位指示灯（20A） |
| GPIO21 | LED_MONO_2 | 电流档位指示灯（25A） |
| GPIO18 | LED_MONO_3 | 电流档位指示灯（32A） |
| GPIO22 | LED_MONO_4 | 电流档位指示灯（40A） |
| GPIO19 | LED_MONO_5 | 电流档位指示灯（50A） |
| GPIO23 | LED_MONO_6 | 电流档位指示灯（63A） |
| GPIO33 | RGB_LED_RED | 状态指示灯-红色（异常） |
| GPIO32 | RGB_LED_GREEN | 状态指示灯-绿色（正常） |
| GPIO27 | RGB_LED_BLUE | 状态指示灯-蓝色（备用） |

**RGB状态说明**:
- 红色：电表或PLC通信异常
- 绿色：设备正常且已绑定充电桩
- 黄色（红+绿）：设备正常但未绑定充电桩

#### 按键输入（1个）

| GPIO | 功能 | 说明 |
|------|------|------|
| GPIO4 | 档位设置按键 | 短按切换档位，长按3秒进入/退出设置模式 |

**电流档位**: 20A / 25A / 32A / 40A / 50A / 63A（循环切换）

---

### 2.2 UART串口配置

| UART | TX引脚 | RX引脚 | 波特率 | 校验位 | 功能 |
|------|-------|-------|-------|-------|------|
| UART0 | GPIO1 | GPIO3 | 115200 | 无 | 烧录/DEBUG |
| UART1 | GPIO25 | GPIO26 | 115200 | 偶校验 | PLC模块3121通信 |
| UART2 | GPIO14 | GPIO35 | 4800 | 无 | BL0942电能计量芯片 |

---

### 2.3 通信接口

| 接口类型 | 说明 |
|---------|------|
| WiFi | 支持AP和STA模式，用于远程控制和配置 |
| BLE | Nordic UART Service，用于手机APP通信 |
| PLC | 电力线载波通信，与充电桩通信 |

---

### 2.4 外设芯片

| 芯片型号 | 接口 | 功能 |
|---------|------|------|
| PLC模块3121 | UART1 | 电力线载波通信模块 |
| BL0942 | UART2 | 电能计量芯片（电压/电流/功率/电能） |

---

## 三、软件架构

### 3.1 系统架构图

```
应用层
├── RPC服务接口（WiFi/BLE）

业务层
├── 充电桩管理模块
├── 自动控制模块（负载均衡）
├── 配置管理模块
└── GPIO管理模块

通信层
├── PLC通信管理
├── WiFi管理
├── BLE管理
└── 串口驱动

驱动层
├── PLC模块驱动
├── BL0942电表驱动
├── GPIO/LED驱动
└── 定时器驱动
```

---

### 3.2 主要功能模块

#### 1. 充电桩管理模块
**文件**: `ChargingStationManager.c`
**功能**:
- 搜索和发现PLC网络上的充电桩（最多10个）
- 管理已添加的充电桩（最多2个同时工作）
- 充电桩在线检测和心跳管理
- 实时数据查询（电压、电流、能量、状态等）
- 充电桩控制（启动、停止、暂停充电）

#### 2. PLC通信模块
**文件**: `PlcModule3121.c`、`PlcManager.c`
**功能**:
- 电力线载波(PLC)通信驱动
- AT指令协议处理
- 数据收发队列管理
- 协议编解码和CRC校验

#### 3. 自动控制模块
**文件**: `AllocationController.c`
**功能**:
- 自动负载均衡算法
- 根据电表读数和入户电流智能分配充电电流
- 单桩/双桩充电场景处理
- 自动调整充电桩限制电流（6A-63A）

**算法逻辑**:

```
可用电流 = 入户电流 - (电表当前总电流 - 充电桩占用电流)

单桩充电:
  分配全部可用电流

双桩充电:
  1. 平均电流 >= 最小值(6A): 两桩平均分配
  2. 总电流 >= 最小值(6A): 轮流选择一桩充电，另一桩暂停
  3. 总电流 < 最小值(6A): 两桩都暂停
```

#### 4. BL0942电表驱动
**文件**: `BL0942Meter.c`
**功能**:
- 读取电压、电流、功率、电能、频率
- 数据转换和校验
- 每秒查询一次电表数据

#### 5. WiFi管理模块
**文件**: `WifiManager.c`
**功能**:
- AP模式（作为热点，SSID: ESP32_AP_SN）
- STA模式（连接到路由器）
- WiFi配置保存和读取
- WiFi列表扫描

#### 6. BLE管理模块
**文件**: `BLEManager.c`
**功能**:
- Nordic UART Service（数据通信）
- Heart Rate Service（iOS兼容）
- 设备名称: SN
- JSON/二进制-RPC请求处理

#### 7. GPIO管理模块
**文件**: `GPIOManager.c`
**功能**:
- LED/RGB状态指示控制
- 按键检测和防抖（50ms消抖）
- 电流档位设置和显示
- 系统状态监控

#### 8. 配置管理模块
**文件**: `ConfigManager.c`
**功能**:
- NVS Flash存储配置数据
- JSON格式配置读写
- WiFi配置持久化
- 充电桩配置管理
- 电表系数配置

#### 9. OTA固件升级模块
**文件**: `OTAManager.c`
**功能**:
- **通过BLE蓝牙**进行OTA固件更新
- 分帧传输（开始帧/数据帧/结束帧/应答帧）
- CRC16校验和数据完整性验证
- 固件版本管理（NVS存储）
- ESP32双分区安全升级

---

### 3.3 FreeRTOS任务列表

| 任务名称 | 优先级 | 功能 |
|---------|-------|------|
| `CheckStationThread` | 5 | 充电桩扫描和在线检测 |
| `AutoControl_task` | 5 | 负载均衡和自动控制（10秒周期） |
| `plc_monitor_task` | 5 | PLC数据接收和处理 |
| `plc_send_data_task` | 5 | PLC数据发送队列处理 |
| `bl0942_query` | 5 | 电能计量查询（1秒周期） |
| `GPIOManager_Task` | 5 | 按键和LED控制（10ms周期） |
| `BLE_Init_task` | 5 | BLE连接和数据处理 |
| `ota_task` | 5 | OTA固件升级监控 |
| `systick_timer_task` | 5 | 软件定时器驱动（10ms周期） |

---

## 四、核心业务流程

### 4.1 系统启动流程

```
1. NVS Flash初始化
2. 配置管理初始化（加载配置）
3. 网络初始化（WiFi/BLE）
4. GPIO初始化（LED/按键）
5. 定时器系统初始化
6. PLC通信初始化
7. 充电桩管理器初始化
8. 电表初始化
9. 自动控制模块初始化
10. 创建各业务任务
```

### 4.2 充电桩管理流程

```
扫描 → 发现 → 添加 → 连接 → 监控 → 控制 → 充电 → 停止
  ↓      ↓      ↓      ↓      ↓      ↓      ↓      ↓
10秒   获取   保存   初始   心跳   查询   启动   限流
周期   MAC   配置   命令   检测   数据   充电   调整
```

**详细步骤**:
1. **扫描**: 每10秒发送AT+TOPOINFO命令扫描PLC网络
2. **发现**: 获取充电桩MAC、版本、序列号、信号强度
3. **添加**: 通过APP添加充电桩（最多2个），保存到NVS
4. **连接**: 发送初始化命令，获取设备信息
5. **监控**: 每500ms查询实时数据（电压/电流/能量/状态）
6. **控制**: 远程启动/停止充电
7. **充电**: 实时监控充电状态，自动负载均衡
8. **停止**: 充电完成或手动停止

### 4.3 自动控制流程

```
定时器触发（10秒） → 获取电表数据 → 获取入户电流 → 计算可用电流
    ↓
判断充电桩数量和状态
    ↓
├─ 单桩充电: 分配全部可用电流
└─ 双桩充电: 平均分配可用电流
    ↓
计算限制电流（6A-32A范围）
    ↓
下发限制电流命令到充电桩
```

### 4.4 PLC通信流程

**发送**:
```
业务请求 → 组装命令 → CRC校验 → 入队 → 发送任务 → UART1输出
```

**接收**:
```
UART1接收 → 接收队列 → 协议解析 → 数据提取 → 更新状态 → 事件通知
```

### 4.5 RPC远程控制流程

**WiFi/BLE RPC**:
```
手机APP → WiFi/BLE → JSON-RPC请求 → 业务处理 → 返回结果 → APP显示
```

**主要RPC接口**:
- `SearchChargeStationRequest`: 搜索充电桩
- `SelectSubDeviceByPortName`: 查询已添加的充电桩
- `UpdateMajorSubDeviceByPortName`: 添加/删除充电桩
- `StartChargingRequest`: 启动充电
- `StopChargingRequest`: 停止充电
- `SelectChargingDetails`: 查询充电详情
- `SelectWifiList`: 扫描WiFi列表
- `SetConfig/GetConfig`: 配置管理

---

### 4.6 电表数据查询流程

**BL0942查询任务**（bl0942_query_task，1秒周期）:

```
启动延迟1秒
  ↓
进入循环
  ↓
查询所有寄存器（bl0942_query_all_registers）
  ├─ 查询电压寄存器（0x04）
  ├─ 查询电流寄存器（0x03）
  ├─ 查询功率寄存器（0x06）
  ├─ 查询能量寄存器（0x07）
  └─ 查询频率寄存器（0x08）
  ↓
每个寄存器查询流程：
  ├─ 发送查询命令（0x5A + 寄存器地址）
  ├─ 延迟25ms（满足帧间隔要求）
  ├─ 读取UART2响应（4字节）
  ├─ 数据校验和CRC验证
  └─ 应用转换系数得到实际值
  ↓
存储到全局变量
  ├─ bl0942_data.voltage（电压，单位V）
  ├─ bl0942_data.current（电流，单位A）
  ├─ bl0942_data.power（功率，单位W）
  ├─ bl0942_data.energy（电能，单位kWh）
  └─ bl0942_data.frequency（频率，单位Hz）
  ↓
等待1秒
  ↓
重复循环
```

**数据转换公式**:
- 电压 = 原始值 / 电压系数
- 电流 = 原始值 / 电流系数
- 功率 = 原始值 / 功率系数
- 电能 = 原始值 * 能量系数
- 频率 = 频率系数 / 原始值

**系数来源**: NVS配置（`bl0942_coef`）或默认值

---

### 4.7 GPIO控制和状态指示流程

**GPIO管理任务**（GPIOManager_Control_Task，10ms周期）:

#### 1. RGB LED状态指示（每1秒更新）

```
检查系统状态
  ├─ 检查电表通信状态（bl0942_is_connected）
  ├─ 检查PLC通信状态（GetSelfMac是否为空）
  └─ 检查充电桩绑定状态（是否有isAdded=true的设备）
  ↓
按优先级设置LED颜色
  ├─ 优先级1：电表或PLC异常 → 红色
  ├─ 优先级2：正常且已绑定设备 → 绿色
  └─ 优先级3：正常但未绑定设备 → 黄色
```

**RGB LED颜色含义**:
- 🔴 **红色**: 电表通信异常或PLC通信异常
- 🟢 **绿色**: 系统正常且已添加充电桩
- 🟡 **黄色**: 系统正常但未添加充电桩

#### 2. 按键控制状态机

```
【空闲状态】(KEY_STATE_IDLE)
  ↓ 检测到按键按下
【按下状态】(KEY_STATE_PRESSED)
  ├─ 按键持续时间 < 3秒 → 释放 → 短按事件
  │   └─ 在设置模式下：切换到下一档位（20→25→32→40→50→63→20）
  │       └─ 更新LED显示
  └─ 按键持续时间 ≥ 3秒 → 长按事件
      ├─ 未在设置模式 → 进入设置模式
      │   └─ 当前档位LED闪烁反馈
      └─ 已在设置模式 → 退出设置模式
          ├─ 当前档位LED闪烁反馈
          └─ 保存电流档位到NVS（InletCurrent）
```

#### 3. 单色LED档位显示

```
根据InletCurrent值点亮对应LED
  ├─ 20A → LED1（GPIO13）点亮
  ├─ 25A → LED2（GPIO21）点亮
  ├─ 32A → LED3（GPIO18）点亮
  ├─ 40A → LED4（GPIO22）点亮
  ├─ 50A → LED5（GPIO19）点亮
  └─ 63A → LED6（GPIO23）点亮
```

**LED闪烁反馈**:
- 进入/退出设置模式时，当前档位LED闪烁3次
- 闪烁周期：500ms（亮250ms，灭250ms）

---

### 4.8 OTA固件升级流程

**BLE OTA升级流程**:

```
手机APP发送开始帧（0x01）
  ├─ 包含：total_size（总大小）、version（版本号）、crc16
  ├─ 设备解析并准备OTA分区
  └─ 回复ACK（0x04）
  ↓
手机APP分包发送数据帧（0x02）
  ├─ 每包格式：packet_id（包序号）+ data（数据）+ crc16
  ├─ 设备接收并写入Flash
  ├─ 验证CRC16
  ├─ 计算进度百分比
  └─ 回复ACK（包含received_bytes和progress）
  ↓
循环传输直到所有数据包发送完成
  ↓
手机APP发送结束帧（0x03）
  ├─ 包含：total_packets、total_size、final_crc32、crc16
  ├─ 设备验证数据完整性
  ├─ 设置boot分区
  ├─ 更新版本号到NVS
  └─ 回复ACK并重启系统
  ↓
系统重启，引导加载程序验证新固件
  ↓
新固件启动
```

**错误处理**:
- CRC校验失败 → 返回错误码0x11
- 包序号错误 → 返回错误码0x12
- Flash写入失败 → 返回错误码0x13
- 固件验证失败 → 返回错误码0x15

---

## 五、配置参数

### 5.1 系统配置（NVS存储）

| 配置项 | 键名 | 数据类型 | 说明 |
|-------|------|---------|------|
| 设备序列号 | subDevId | String | 设备唯一标识，用于BLE名称和系统识别 |
| WiFi配置 | wifi_config | JSON | WiFi的AP、STA模式、SSID和密码 |
| 充电桩配置 | ev_config | JSON | 充电桩的MAC地址、序列号、最大电流等 |
| 电表系数 | bl0942_coef | JSON | BL0942电压/电流/功率/能量/频率转换系数 |
| 入户电流 | InletCurrent | UInt8 | 家庭入户最大电流档位（20/25/32/40/50/63A） |
| 固件版本 | fw_version | String | 固件版本号（用于OTA升级） |

---
